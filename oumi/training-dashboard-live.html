<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oumi GRPO Training - Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-orange-500 mb-2">üî• Oumi GRPO Training</h1>
            <p class="text-gray-400">Real-Time Training Dashboard - Review-Forge Model</p>
            <p class="text-xs text-gray-500 mt-1">Connected to training server ‚Ä¢ Auto-refreshing every 500ms</p>
        </div>

        <!-- Control Panel -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold mb-2">Training Control</h2>
                    <p id="currentStep" class="text-gray-400">Click Start to begin training...</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="statusBadge" class="flex items-center">
                        <span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>
                        <span class="text-gray-400 font-medium">Idle</span>
                    </div>
                    <button id="startBtn" onclick="startTraining()" 
                            class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-medium transition">
                        ‚ñ∂ Start Training
                    </button>
                </div>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Current Epoch</p>
                <p id="epoch" class="text-3xl font-bold text-blue-400">0/10</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Training Loss</p>
                <p id="loss" class="text-3xl font-bold text-red-400">--</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Reward Score</p>
                <p id="reward" class="text-3xl font-bold text-green-400">--</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Feedback Samples</p>
                <p id="samples" class="text-3xl font-bold text-purple-400">--</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Training Loss <span class="text-red-400">(‚Üì lower is better)</span></h3>
                <canvas id="lossChart" height="200"></canvas>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Reward Score <span class="text-green-400">(‚Üë higher is better)</span></h3>
                <canvas id="rewardChart" height="200"></canvas>
            </div>
        </div>

        <!-- GRPO Process -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">GRPO Training Pipeline</h3>
            <div class="flex items-center justify-between">
                <div id="step_load_data" class="flex-1 text-center p-4 bg-gray-700 rounded-lg mx-1">
                    <div class="text-2xl mb-2">üì•</div>
                    <p class="font-medium">Load Feedback</p>
                    <p class="text-xs text-gray-400">from submit_feedback</p>
                </div>
                <div class="text-gray-500">‚Üí</div>
                <div id="step_load_model" class="flex-1 text-center p-4 bg-gray-700 rounded-lg mx-1">
                    <div class="text-2xl mb-2">üß†</div>
                    <p class="font-medium">Load Model</p>
                    <p class="text-xs text-gray-400">TinyLlama + LoRA</p>
                </div>
                <div class="text-gray-500">‚Üí</div>
                <div id="step_generate" class="flex-1 text-center p-4 bg-gray-700 rounded-lg mx-1">
                    <div class="text-2xl mb-2">üé≤</div>
                    <p class="font-medium">Generate</p>
                    <p class="text-xs text-gray-400">Multiple responses</p>
                </div>
                <div class="text-gray-500">‚Üí</div>
                <div id="step_compute_reward" class="flex-1 text-center p-4 bg-gray-700 rounded-lg mx-1">
                    <div class="text-2xl mb-2">‚öñÔ∏è</div>
                    <p class="font-medium">Compute Reward</p>
                    <p class="text-xs text-gray-400">Score responses</p>
                </div>
                <div class="text-gray-500">‚Üí</div>
                <div id="step_update_weights" class="flex-1 text-center p-4 bg-gray-700 rounded-lg mx-1">
                    <div class="text-2xl mb-2">üìà</div>
                    <p class="font-medium">Update</p>
                    <p class="text-xs text-gray-400">Policy gradient</p>
                </div>
            </div>
        </div>

        <!-- File Upload & Test Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">üìÅ Upload Training Data</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- File Upload -->
                <div>
                    <p class="text-gray-400 text-sm mb-3">Upload a JSONL file with coding rules and review examples</p>
                    <input type="file" id="trainingFile" accept=".jsonl,.json" 
                           class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-700 cursor-pointer">
                    <button onclick="uploadTrainingData()" 
                            class="mt-3 bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg font-medium transition w-full">
                        üì§ Upload & Add to Training Data
                    </button>
                    <p id="uploadStatus" class="text-sm mt-2 text-gray-400"></p>
                </div>
                <!-- Quick Add Sample -->
                <div>
                    <p class="text-gray-400 text-sm mb-3">Or load pre-built coding rules</p>
                    <button onclick="loadSampleRules()" 
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-medium transition w-full">
                        üìö Load Sample Coding Rules (15 examples)
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Includes: SQL injection, null checks, naming conventions, error handling, etc.</p>
                </div>
            </div>
        </div>

        <!-- Before/After Test Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">üß™ Test Model (Before vs After Training)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="text-gray-400 text-sm">Enter a code review to score:</label>
                    <textarea id="testReview" rows="3" 
                              class="w-full mt-2 p-3 bg-gray-700 rounded-lg text-white border border-gray-600 focus:border-orange-500 focus:outline-none"
                              placeholder="e.g., 'LGTM' or 'Consider adding null check on line 42'"></textarea>
                    <button onclick="testModel()" 
                            class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition w-full">
                        üîç Test Model Scoring
                    </button>
                </div>
                <div>
                    <label class="text-gray-400 text-sm">Model Response:</label>
                    <div id="testResult" class="mt-2 p-3 bg-gray-700 rounded-lg min-h-[100px] text-sm">
                        <span class="text-gray-500">Enter a review and click Test to see the model's scoring...</span>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <span id="beforeScore" class="text-xs bg-red-900 px-2 py-1 rounded">Before: --</span>
                        <span id="afterScore" class="text-xs bg-green-900 px-2 py-1 rounded">After: --</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reward Function -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">Real Reward Function</h3>
            <pre class="bg-gray-900 p-4 rounded text-sm text-green-400 overflow-x-auto">
def compute_reward(completion: str) -> float:
    reward = 0.0
    
    if "Score:" in completion:           reward += 0.3   # Has overall score
    if "/25" in completion:              reward += 0.2   # Has dimension scores
    if "Clarity" in completion:          reward += 0.1   # Mentions clarity
    if "Completeness" in completion:     reward += 0.1   # Mentions completeness
    if "Actionability" in completion:    reward += 0.1   # Mentions actionability
    if "Constructiveness" in completion: reward += 0.1   # Mentions constructiveness
    
    return min(reward, 1.0)  # Max reward = 1.0
            </pre>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="text-center text-gray-500 text-sm">
            Connecting to training server...
        </div>
    </div>

    <script>
        // Chart setup
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                animation: { duration: 300 },
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } },
                    y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } }
                }
            }
        };

        const lossChart = new Chart(document.getElementById('lossChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            }
        });

        const rewardChart = new Chart(document.getElementById('rewardChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            }
        });

        // Start training
        async function startTraining() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'Starting...';
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-gray-600');
            
            try {
                const res = await fetch('/start');
                const data = await res.json();
                if (data.status === 'already_running') {
                    alert('Training is already running!');
                }
            } catch (e) {
                console.error('Failed to start:', e);
            }
        }

        // Update dashboard from server metrics
        async function updateDashboard() {
            try {
                const res = await fetch('/metrics');
                const metrics = await res.json();
                
                // Update status
                const statusBadge = document.getElementById('statusBadge');
                const statusColors = {
                    'idle': ['bg-gray-500', 'text-gray-400', 'Idle'],
                    'starting': ['bg-yellow-500', 'text-yellow-400', 'Starting...'],
                    'initializing': ['bg-yellow-500', 'text-yellow-400', 'Initializing...'],
                    'training': ['bg-blue-500', 'text-blue-400', 'Training...'],
                    'completed': ['bg-green-500', 'text-green-400', 'Completed ‚úì']
                };
                const [dotColor, textColor, label] = statusColors[metrics.status] || statusColors['idle'];
                statusBadge.innerHTML = `
                    <span class="w-3 h-3 ${dotColor} rounded-full mr-2 ${metrics.status === 'training' ? 'animate-pulse-slow' : ''}"></span>
                    <span class="${textColor} font-medium">${label}</span>
                `;
                
                // Update button
                const btn = document.getElementById('startBtn');
                if (metrics.status === 'completed') {
                    btn.disabled = false;
                    btn.textContent = '‚Üª Restart Training';
                    btn.classList.remove('bg-gray-600');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else if (metrics.status === 'training' || metrics.status === 'initializing') {
                    btn.disabled = true;
                    btn.textContent = 'Training...';
                }
                
                // Update metrics
                document.getElementById('currentStep').textContent = metrics.current_step || 'Waiting...';
                document.getElementById('epoch').textContent = `${metrics.epoch}/${metrics.total_epochs}`;
                document.getElementById('loss').textContent = metrics.loss > 0 ? metrics.loss.toFixed(4) : '--';
                document.getElementById('reward').textContent = metrics.reward > 0 ? metrics.reward.toFixed(4) : '--';
                document.getElementById('samples').textContent = metrics.samples || '--';
                
                // Update charts
                if (metrics.history && metrics.history.epochs.length > 0) {
                    lossChart.data.labels = metrics.history.epochs.map(e => `E${e}`);
                    lossChart.data.datasets[0].data = metrics.history.loss;
                    lossChart.update('none');
                    
                    rewardChart.data.labels = metrics.history.epochs.map(e => `E${e}`);
                    rewardChart.data.datasets[0].data = metrics.history.reward;
                    rewardChart.update('none');
                }
                
                // Update pipeline steps
                const steps = ['load_data', 'load_model', 'generate', 'compute_reward', 'update_weights'];
                const completed = metrics.steps_completed || [];
                steps.forEach(step => {
                    const el = document.getElementById(`step_${step}`);
                    el.classList.remove('bg-green-900', 'bg-blue-900', 'bg-gray-700', 'animate-pulse-slow');
                    
                    if (completed.includes(step)) {
                        if (step === completed[completed.length - 1] && metrics.status === 'training') {
                            el.classList.add('bg-blue-900', 'animate-pulse-slow');
                        } else {
                            el.classList.add('bg-green-900');
                        }
                    } else {
                        el.classList.add('bg-gray-700');
                    }
                });
                
                document.getElementById('connectionStatus').textContent = 
                    `‚úì Connected to training server ‚Ä¢ Last update: ${new Date().toLocaleTimeString()}`;
                
            } catch (e) {
                document.getElementById('connectionStatus').textContent = 
                    '‚ö† Cannot connect to server. Run: python training_server.py';
            }
        }

        // Poll server every 500ms
        setInterval(updateDashboard, 500);
        updateDashboard();

        // Upload training data file
        async function uploadTrainingData() {
            const fileInput = document.getElementById('trainingFile');
            const statusEl = document.getElementById('uploadStatus');
            
            if (!fileInput.files.length) {
                statusEl.textContent = '‚ö†Ô∏è Please select a file first';
                statusEl.className = 'text-sm mt-2 text-yellow-400';
                return;
            }
            
            const file = fileInput.files[0];
            statusEl.textContent = '‚è≥ Uploading...';
            statusEl.className = 'text-sm mt-2 text-blue-400';
            
            try {
                const text = await file.text();
                const lines = text.trim().split('\n').filter(l => l.trim());
                
                let successCount = 0;
                for (const line of lines) {
                    try {
                        const data = JSON.parse(line);
                        const res = await fetch('/upload-training', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        if (res.ok) successCount++;
                    } catch (e) {
                        console.error('Invalid line:', line);
                    }
                }
                
                statusEl.textContent = `‚úÖ Uploaded ${successCount}/${lines.length} training samples!`;
                statusEl.className = 'text-sm mt-2 text-green-400';
                updateDashboard();
            } catch (e) {
                statusEl.textContent = '‚ùå Upload failed: ' + e.message;
                statusEl.className = 'text-sm mt-2 text-red-400';
            }
        }

        // Load sample coding rules
        async function loadSampleRules() {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = '‚è≥ Loading sample rules...';
            statusEl.className = 'text-sm mt-2 text-blue-400';
            
            try {
                const res = await fetch('/load-sample-rules', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    statusEl.textContent = `‚úÖ Loaded ${data.count} coding rules for training!`;
                    statusEl.className = 'text-sm mt-2 text-green-400';
                } else {
                    statusEl.textContent = '‚ùå ' + (data.error || 'Failed to load');
                    statusEl.className = 'text-sm mt-2 text-red-400';
                }
                updateDashboard();
            } catch (e) {
                statusEl.textContent = '‚ùå Error: ' + e.message;
                statusEl.className = 'text-sm mt-2 text-red-400';
            }
        }

        // Test model scoring
        async function testModel() {
            const review = document.getElementById('testReview').value.trim();
            const resultEl = document.getElementById('testResult');
            const beforeEl = document.getElementById('beforeScore');
            const afterEl = document.getElementById('afterScore');
            
            if (!review) {
                resultEl.innerHTML = '<span class="text-yellow-400">Please enter a review to test</span>';
                return;
            }
            
            resultEl.innerHTML = '<span class="text-blue-400 animate-pulse">‚è≥ Testing model...</span>';
            
            try {
                const res = await fetch('/test-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ review })
                });
                const data = await res.json();
                
                if (data.success) {
                    resultEl.innerHTML = `
                        <div class="text-green-400 font-semibold mb-2">Model Output:</div>
                        <pre class="whitespace-pre-wrap text-gray-300">${data.result}</pre>
                    `;
                    beforeEl.textContent = `Before: ${data.before_score}/100`;
                    afterEl.textContent = `After: ${data.after_score}/100`;
                    
                    // Color based on improvement
                    if (data.after_score > data.before_score) {
                        afterEl.className = 'text-xs bg-green-600 px-2 py-1 rounded';
                    }
                } else {
                    resultEl.innerHTML = `<span class="text-red-400">‚ùå ${data.error}</span>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<span class="text-red-400">‚ùå Error: ${e.message}</span>`;
            }
        }
    </script>
</body>
</html>
